; (function($, window, document, undefined) {
    "use strict";
    var pluginName = 'jqMultiSelect',
		defaults = {
		    id: "",
		    width: 100,
		    height: 100,
		    dropDownWidth: null,
		    enabled: true,
		    items: [],
		    tabIndex: -1,
		    initialText: "",
		    itemTemplateID: "",
		    headerTemplateID: "",
		    footerTemplateID: "",
		    toggleImageCssClass: "ui-icon-triangle-1-s",
		    filter: "none",
		    onShow: null,
		    onHide: null,
		    onSelect: null,
		    onMouseOver: null,
		    onMouseOut: null,
		    onInitialized: null,
		    onKeyDown: null
		};

    function MultiSelect(element, options) {
        this.self = $(element);
        this.options = $.extend({}, defaults, options);

        if (this.options.dropDownWidth === null) {
            this.options.dropDownWidth = this.options.width;
        }

        this.toggleActive = false;
        this.dropDownVisible = false;
        this.selectedIndex = -1;
        this.keyboardIndex = -1;
        this.selectedItems = [];
        this.cancelChange = false;

        $(element).prop("multiselect", this);

        this.renderToLevelButton();
        if (this.options.items.length > 0) {
            this.renderItems(this.options.items);
        }

        for (var i = 0; i < this.options.items.length; i++) {
            if (this.options.items[i].selected) {
                this.selectedItems.push(i);
            }                
        }

        this.renderHiddenValueField();
        this.renderSelectedItems();
        this.attachEvents();
        

        if (this.selectedIndex > -1) {
            this.keyboardIndex = this.selectedIndex;
            var item = this.getItemByIndex(this.selectedIndex);
            item.find("tr:eq(0)").addClass("ui-state-highlight");
        }

        for (var i = 0; i < this.options.items.length; i++) {
            if (this.options.items[i].selected) {
                this.disableItem(this.getItemByIndex(i));
            }
        }

        this.serializeSelectedValue();

        if (this.options.onInitialized) {
            this.options.onInitialized(this);
        }        
    };

    MultiSelect.prototype.renderToLevelButton = function() {
        var sb = [];
        var o = this.options;

        sb.push("<div tabindex=" + o.tabIndex + " id='" + o.id + "_placeholder' class='ui-jqmultiselect-placeholder ui-state-default ui-widget ui-corner-all' style='width:" + o.width + "px;'>");
        sb.push("<ul class='ui-jqmultiselect-choices'>");

        sb.push("</ul>");
        sb.push("</div>");

        var htmlElement = $(sb.join(""));
        this.self.append(htmlElement);
    };

    MultiSelect.prototype.renderItems = function(json) {
        var that = this;
        var sb = [];

        sb.push("<div id=" + this.options.id + "_dropDownWrapper class='ui-jqmultiselect-dropdown-wrapper ui-widget ui-widget-content ui-corner-all'");
        sb.push(">");

        if (this.options.headerTemplateID) {
            sb.push("<div id=" + this.options.id + "_dropDownHeader>");
            sb.push(this.renderTemplate(this.options.headerTemplateID));
            sb.push("</div>");
        }

        sb.push("<div id=" + this.options.id + "_dropDown class='ui-jqmultiselect-dropdown'");
        sb.push(" style='");
        sb.push("width:" + this.options.dropDownWidth + "px;");
        if (this.options.height !== 100) {
            sb.push("height:" + this.options.height + "px;");
        }
        sb.push("'>");

        sb.push("<ul class='ui-helper-reset' style='width:" + this.options.dropDownWidth + "px;");
        if (this.options.height !== 100) {
            sb.push("height:" + this.options.height + "px;");
        }
        sb.push("'>");
        sb.push("</ul>");
        sb.push("</div>");

        if (this.options.footerTemplateID) {
            sb.push("<div id=" + this.options.id + "_dropDownFooter>");
            sb.push(this.renderTemplate(this.options.footerTemplateID));
            sb.push("</div>");
        }

        sb.push("</div>");

        var htmlElement = $(sb.join(""));
        this.parentElement = htmlElement.find("ul:eq(0)");

        $.each(json, function(index, options) {
            if (options.selected) {
                this.selectedIndex = index;
            }
            options.index = index;
            if (options.value === undefined) {
                options.value = options.text;
            }
            options.enabled = (options.enabled === undefined) ? true : false;

            that.renderItem(options, that.parentElement);
        });

        if (this.selectedIndex === -1 && json.length > 0) {
            this.selectedIndex = 0;
        }

        $("body").append(htmlElement);
    };

    MultiSelect.prototype.renderItem = function(json, parentElement) {
        var templateID = null;
        var sb = [];
        var text = json.text;
        var disabledCss = "";

        if (this.options.itemTemplateID) {
            templateID = this.options.itemTemplateID;
        }
        if (json.itemTemplateID) {
            templateID = json.itemTemplateID;
        }
        if (templateID) {
            text = this.renderTemplate(templateID, json);
        }
        if (!json.enabled) {
            disabledCss = "ui-state-disabled";
        }

        sb.push("<li class='ui-jqmultiselect-item'>");
        sb.push("<a onfocus='this.blur();'>");
        sb.push("<table cellpadding=0 cellspacing=0 style='width:100%;' class='ui-helper-reset'>");
        sb.push("<tr>");
        if (json.imageUrl) {
            sb.push("<td valign=middle style='width:21px;text-align:center;'><img class='ui-jqmultiselect-item-image' src='" + json.imageUrl + "' /></td>");
        }
        sb.push("<td valign=middle style='width:100%;' class='ui-corner-all'>");
        sb.push("<span class='ui-jqmultiselect-item-text " + disabledCss + "'>" + text + "</span>");
        sb.push("</td>");
        sb.push("</tr></table></a>");
        sb.push("</li>");

        var newItem = $(sb.join(""));
        newItem.data("options", json);        

        parentElement.append(newItem);
    };

    MultiSelect.prototype.renderTemplate = function(templateID, json) {
        if (!$.isFunction($.tmpl)) {
            alert("You have specified using templates with jqMultiSelect, but the jQuery template library javascript is not referenced in the HTML.");
            return;
        }
        if ($("#" + templateID).length === 0) {
            alert("You have not specified a jQuery template with ID " + templateID + " that is not defined on the page");
            return;
        }

        if (json) {
            return $("#" + templateID).tmpl(json).clone().wrap('<div></div>').parent().html();
        }

        return $("#" + templateID).tmpl().clone().wrap('<div></div>').parent().html();
    };

    MultiSelect.prototype.renderHiddenValueField = function() {
        var selectedID = this.getSelectedValueHiddenID();
        this.self.remove("#" + selectedID).append("<input type='hidden' id='" + selectedID + "' name='" + selectedID + "' />");
    };  

    MultiSelect.prototype.renderInput = function () {
        var sb = [];
        sb.push("<li class='ui-jqmultiselect-search-field' style='list-style:none; float:left;'>");
        sb.push("<input type='text' value='' class='ui-jqmultiselect-search-input' autocomplete='off' style='width:25px;'></input>");
        sb.push("</li>");
        // TODO - HandleInputChange - change input size

        this.getTopLevelUl().append(sb.join(""));
        this.attachInputEvents();
        this.clearFilter();
    };

    MultiSelect.prototype.renderSelectedItem = function(options, actualItem) {
        var sb = [];
        sb.push("<li class='ui-widget ui-corner-all ui-jqmultiselect-search-choice'>");
        sb.push("<span>" + options.text + "</span>");
        sb.push("<span class='ui-icon ui-icon-close' style='float:right'></span>");
        sb.push("</li>");

        var item = $(sb.join(""));
        item.data("actualItem", actualItem);
        this.getTopLevelUl().append(item);
    };

    MultiSelect.prototype.renderSelectedItems = function() {
        this.getTopLevelUl().find(".ui-jqmultiselect-search-choice").remove();
        this.getTopLevelUl().find(".ui-jqmultiselect-search-field").remove();
        for (var i = 0; i < this.selectedItems.length; i++) {
            var item = this.getItemByIndex(this.selectedItems[i]);
            var options = this.getItemOptions(item);
            this.renderSelectedItem(options, item);
        }
        this.renderInput();
    };

    MultiSelect.prototype.showDropDown = function() {
        if (this.options.onShow) {
            this.options.onShow();
        }

        this.dropDownVisible = true;
        var dropDown = this.getDropDownElement();
        var button = this.getTopLevelButton(); //.find("ul");
        var offset = button.offset();

        dropDown.css({
            top: offset.top + button.outerHeight(),
            left: offset.left
        }).slideDown(120);

        if (this.selectedIndex > -1) {
            this.ensureVisible(this.getItemByIndex(this.selectedIndex));
        }
    };

    MultiSelect.prototype.hideDropDown = function() {
        if (this.options.onHide) {
            this.options.onHide();
        }

        this.dropDownVisible = false;
        var dropDown = this.getDropDownElement();
        dropDown.slideUp(120);
    };

    MultiSelect.prototype.toggleDropDown = function() {
        if (this.dropDownVisible) {
            this.hideDropDown();
        } else {
            this.showDropDown();
        }
    };

    MultiSelect.prototype.handleClick = function(event) {
        var target = $(event.target);

        if (target.hasClass("ui-icon-close")) {
            this.removeFromSelectedList(target);
            return false;
        }

        if (this.options.enabled) {
            this.toggleDropDown();
            event.preventDefault();
            return false;
        }
    };   

    // need this to cancel blur from firing on scrollbar click
    MultiSelect.prototype.handleDropDownMouseDown = function(event) {
        event.preventDefault();
        return false;
    };

    // need this to cancel blur from firing in IE - hack
    MultiSelect.prototype.handleDropDownFocus = function(event) {
        this.getInputElement.focus();
    };

    MultiSelect.prototype.handleKeyDown = function(event) {
        if (this.options.onKeyDown) {
            var result = this.options.onKeyDown(this, event);
            if (result === false) {
                return;
            }
        }

        switch (event.keyCode) {
            case 40:
                var nextIndex = this.getNextActiveIndex(this.keyboardIndex);
                var item = this.getItemByIndex(nextIndex);
                this.cancelChange = true;
                this.select(item);
                event.preventDefault();
                break;
            case 38:
                var prevIndex = this.getPrevActiveIndex(this.keyboardIndex);
                var item = this.getItemByIndex(prevIndex);
                this.cancelChange = true;
                this.select(item);
                event.preventDefault();
                break;
            case 27:
                if (this.dropDownVisible) {
                    this.hideDropDown();
                }
                break;
            case 9:
            case 13:                
                var item = this.getItemByIndex(this.selectedIndex);
                if (item) {
                    var options = this.getItemOptions(item);

                    if (options && options.enabled) {
                        this.addToSelectedList(item, options);
                    }
                }
                //if (this.dropDownVisible) {
                  //  this.hideDropDown();
                //}
                event.preventDefault();
                break;

        }
    };

    MultiSelect.prototype.getNextActiveIndex = function(index) {
        var originalIndex = index;
        while (index < this.getItemCount() - 1) {
            index++;
            var item = this.getItemByIndex(index);
            var options = this.getItemOptions(item);
            if (options.enabled && $(item).css("display") != "none") {
                return index;
            }
        }

        return originalIndex;
    };

    MultiSelect.prototype.getPrevActiveIndex = function(index) {
        var originalIndex = index;
        while (index > 0) {
            index--;
            var item = this.getItemByIndex(index);
            var options = this.getItemOptions(item);
            if (options.enabled && $(item).css("display") != "none") {
                return index;
            }
        }
        return originalIndex;
    };    

    MultiSelect.prototype.handleFocus = function () {
        this.getInputElement().focus();
    };

    MultiSelect.prototype.handleInputFocus = function () {
        this.closeActive = false;
    };

    MultiSelect.prototype.handleInputBlur = function() {
        var that = this;
        this.closeActive = true;
        window.setTimeout(
			function() {
			    if (that.closeActive) {
			        that.hideDropDown();
			        that.closeActive = false;
			    }
			},
		100);
    };

    MultiSelect.prototype.handleInputChange = function () {
        if (this.cancelChange) {
            this.cancelChange = false;
            return;
        }

        if (!this.dropDownVisible) {
            this.showDropDown();
        }    
        
        if (this.options.filter != "none") {
            this.filterItems();
        }

        var text = this.getText();
        var item = this.getItemByText(text);
        if (item != null) {
            var options = this.getItemOptions(item);
            if (this.selectedIndex != options.index && options.enabled) {
                this.select(item);
            }
        }
        else {
            this.getDropDownElement().find(".ui-state-highlight")
                                    .removeClass("ui-state-highlight")
                                    .addClass("ui-state-hover");
            this.selectedIndex = -1;
        }
    };

    MultiSelect.prototype.filterItems = function () {
        var text = this.getText();
        var that = this;
        var items = this.getDropDownElement().find(".ui-jqmultiselect-item");

        $.each(items, function (index, item) {
            var itemText = that.getItemOptions($(item)).text;
            if (that.options.filter == "contains") {
                (itemText.indexOf(text) == -1)
                   ? $(item).css("display", "none")
                   : $(item).css("display", "block");
            }
            if (that.options.filter == "startswith") {
                (itemText.indexOf(text) == 0)
                   ? $(item).css("display", "block")
                   : $(item).css("display", "none");
            }

        });
    };

    MultiSelect.prototype.clearFilter = function () {
        var items = this.getDropDownElement().find(".ui-jqmultiselect-item");
        $.each(items, function (index, item) {
            $(item).css("display", "block");
        });
    };

    MultiSelect.prototype.handleDropDownMouseOver = function(event) {
        var target = $(event.target);
        var parentLi = this.getItemParentLiElement(target);
        var options = this.getItemOptions(parentLi);

        if (options && options.enabled) {
            parentLi.find("tr:eq(0)").addClass("ui-state-hover");

            if (this.options.onMouseOver) {
                var item = this.getItemParentLiElement(target);
                this.options.onMouseOver(item, event);
            }
        }
    };

    MultiSelect.prototype.handleDropDownMouseOut = function(event) {
        var target = $(event.target);
        var parentLi = this.getItemParentLiElement(target);
        var options = this.getItemOptions(parentLi);

        if (options && options.enabled) {
            target.parents("tr:eq(0)").removeClass("ui-state-hover");

            if (this.options.onMouseOut) {
                var item = this.getItemParentLiElement(target);
                this.options.onMouseOut(item, event);
            }
        }
    };

    MultiSelect.prototype.handleDropDownClick = function(event) {
        var target = $(event.target);
        var item = this.getItemParentLiElement(target);
        var options = this.getItemOptions(item);

        if (item && options && options.enabled) {
            this.addToSelectedList(item, options);
        }
    };

    MultiSelect.prototype.addToSelectedList = function (item, options) {
        if (this.options.onSelect) {
            if (this.options.onSelect(item, event) === false) {
                return;
            }
        }
        this.selectedIndex = options.index;
        if (this.selectedItems.indexOf(options.index) == -1) {
            this.selectedItems.push(options.index);
        }
        this.disableItem(item);
        this.select(item);
        this.hideDropDown();
        this.serializeSelectedValue();
    };

    MultiSelect.prototype.removeFromSelectedList = function (target) {
        var item = this.getItemParentLiElement(target).data("actualItem");
        var options = this.getItemOptions(item);
        var index = this.selectedItems.indexOf(options.index);
        options.selected = false;
        this.enableItem(item);
        this.selectedItems.splice(index, 1);
        this.renderSelectedItems();
        this.hideDropDown();
        this.serializeSelectedValue();
    };

    MultiSelect.prototype.getItemOptions = function(target) {
        return this.getItemParentLiElement(target).data("options");
    };

    MultiSelect.prototype.getItemParentLiElement = function(target) {
        return target.hasClass("ui-jqmultiselect-item") ? target : target.parents("li:eq(0)");
    };

    MultiSelect.prototype.getItemTextElement = function(target) {
        return this.getItemParentLiElement(target).find(".ui-jqmultiselect-item-text");
    };

    MultiSelect.prototype.getDropDownElement = function() {
        return $("#" + this.options.id + "_dropDownWrapper");
    };

    MultiSelect.prototype.getDropDownItemsElement = function() {
        return $("#" + this.options.id + "_dropDown");
    };

    MultiSelect.prototype.getDropDownHeaderElement = function() {
        return $("#" + this.options.id + "_dropDownHeader");
    };

    MultiSelect.prototype.getDropDownFooterElement = function() {
        return $("#" + this.options.id + "_dropDownFooter");
    };

    MultiSelect.prototype.getTopLevelButton = function() {
        return $("#" + this.options.id + "_placeholder");
    };

    MultiSelect.prototype.getTopLevelUl = function(target) {
        return this.getTopLevelButton().find(".ui-jqmultiselect-choices");
    };    

    MultiSelect.prototype.getInputElement = function () {
        return this.getTopLevelButton().find(".ui-jqmultiselect-search-input");
    };

    MultiSelect.prototype.getSelectedValueHiddenID = function() {
        return this.options.id + "_selectedValue";
    };

    MultiSelect.prototype.serializeSelectedValue = function() {
        var selectedItems = [];
        for (var i = 0; i < this.selectedItems.length; i++) {
            var item = this.getItemByIndex(this.selectedItems[i]);
            var options = this.getItemOptions(item);
            selectedItems.push(options);
        }
        var jsonSerializedState = JSON.stringify(selectedItems);
        $("#" + this.getSelectedValueHiddenID()).val(jsonSerializedState);
    };

    $.fn[pluginName] = function(options) {
        return this.each(function() {
            if (!$.data(this, 'plugin_' + pluginName)) {
                $.data(this, 'plugin_' + pluginName, new MultiSelect(this, options));
            }
        });
    };

    MultiSelect.prototype.attachEvents = function() {
        var button = this.getTopLevelButton();
        button.bind('click', this.executeInContext(this, this.handleClick));
        button.bind('keydown', this.executeInContext(this, this.handleKeyDown));
        button.bind('focus', this.executeInContext(this, this.handleFocus));        

        var dropDown = this.getDropDownElement();
        dropDown.bind('mouseover', this.executeInContext(this, this.handleDropDownMouseOver));
        dropDown.bind('mouseout', this.executeInContext(this, this.handleDropDownMouseOut));
        dropDown.bind('click', this.executeInContext(this, this.handleDropDownClick));
        dropDown.bind('mousedown', this.executeInContext(this, this.handleDropDownMouseDown));
        dropDown.bind('focus', this.executeInContext(this, this.handleDropDownFocus));

        var multiSelectItems = this.getDropDownItemsElement();
        multiSelectItems.bind('focus', this.executeInContext(this, this.handleDropDownFocus));
    };

    MultiSelect.prototype.attachInputEvents = function () {
        var input = this.getInputElement();
        input.bind('focus', this.executeInContext(this, this.handleInputFocus));
        input.bind('blur', this.executeInContext(this, this.handleInputBlur));
        input.bind('keyup', this.executeInContext(this, this.handleInputChange));
    };

    MultiSelect.prototype.executeInContext = function(context, func) {
        return function() {
            func.apply(context, arguments);
        };
    };

    // Public API

    MultiSelect.prototype.getItemByText = function(text) {
        var that = this;
        that.resultItem = null;
        var items = this.getDropDownElement().find(".ui-jqmultiselect-item");
        $.each(items, function(index, item) {
            if (that.getItemOptions($(item)).text == text) {
                that.resultItem = $(item);
                return false;
            }
        });

        return that.resultItem;
    };

    MultiSelect.prototype.getItemByValue = function(value) {
        var that = this;
        that.resultItem = null;
        var items = this.getDropDownElement().find(".ui-jqmultiselect-item");
        $.each(items, function(index, item) {
            if (that.getItemOptions($(item)).value == value) {
                that.resultItem = $(item);
                return false;
            }
        });

        return that.resultItem;
    };

    MultiSelect.prototype.getSelectedValue = function () {
        var id = this.getSelectedValueHiddenID();
        return $("#" + id).val();
    };

    MultiSelect.prototype.getSelectedIndex = function() {
        return this.selectedIndex;
    };

    MultiSelect.prototype.getText = function() {
        return this.getInputElement().prop("value");
    };

    MultiSelect.prototype.getItemByIndex = function(index) {
        var item = this.getDropDownElement().find(".ui-jqmultiselect-item:eq(" + index + ")");
        return item.length == 0 ? null : item;
    };

    MultiSelect.prototype.getItemCount = function() {
        return this.getDropDownElement().find("li").length;
    };

    MultiSelect.prototype.select = function (item) {
        if (item) {
            this.unSelectAllItems();
            var options = this.getItemOptions(item);
            if (options.enabled) {
                options.selected = true;
                item.find("tr:eq(0)").addClass("ui-state-highlight");
                this.selectedIndex = this.keyboardIndex = options.index;
                //this.selectedIndex = this.keyboardIndex = -1;
            }

            this.renderSelectedItems();
            this.serializeSelectedValue();
            this.ensureVisible(item);
            this.getInputElement().focus();
        }
    };

    MultiSelect.prototype.unSelectAllItems = function() {
        this.getDropDownElement().find(".ui-state-highlight").removeClass("ui-state-highlight");
        this.getDropDownElement().find(".ui-state-hover").removeClass("ui-state-hover");
        this.selectedIndex = -1;
    };

    MultiSelect.prototype.ensureVisible = function(item) {
        item.scrollIntoView();
    };

    MultiSelect.prototype.enableItem = function(item) {
        this.getItemOptions(item).enabled = true;
        this.getItemTextElement(item).removeClass("ui-state-disabled");
    };

    MultiSelect.prototype.disableItem = function(item) {
        this.getItemOptions(item).enabled = false;
        this.getItemTextElement(item).addClass("ui-state-disabled");
    };

    MultiSelect.prototype.enable = function() {
        this.options.enabled = true;
        this.getInputElement().removeClass("ui-state-disabled");
    };

    MultiSelect.prototype.disable = function() {
        this.options.enabled = false;
        this.getInputElement().addClass("ui-state-disabled");
    };


    $.fn.getMultiSelectInstance = function() {
        return $(this).prop("multiselect");
    };

})(jQuery, window, document);


(function($) {
    var converter = {
        vertical: { x: false, y: true },
        horizontal: { x: true, y: false },
        both: { x: true, y: true },
        x: { x: true, y: false },
        y: { x: false, y: true }
    };

    var settings = {
        duration: "fast",
        direction: "both"
    };

    var rootrx = /^(?:html)$/i;

    // gets border dimensions
    var borders = function(domElement, styles) {
        styles = styles || (document.defaultView && document.defaultView.getComputedStyle ? document.defaultView.getComputedStyle(domElement, null) : domElement.currentStyle);
        var px = document.defaultView && document.defaultView.getComputedStyle ? true : false;
        var b = {
            top: (parseFloat(px ? styles.borderTopWidth : $.css(domElement, "borderTopWidth")) || 0),
            left: (parseFloat(px ? styles.borderLeftWidth : $.css(domElement, "borderLeftWidth")) || 0),
            bottom: (parseFloat(px ? styles.borderBottomWidth : $.css(domElement, "borderBottomWidth")) || 0),
            right: (parseFloat(px ? styles.borderRightWidth : $.css(domElement, "borderRightWidth")) || 0)
        };
        return {
            top: b.top,
            left: b.left,
            bottom: b.bottom,
            right: b.right,
            vertical: b.top + b.bottom,
            horizontal: b.left + b.right
        };
    };

    var dimensions = function($element) {
        var win = $(window);
        var isRoot = rootrx.test($element[0].nodeName);
        return {
            border: isRoot ? { top: 0, left: 0, bottom: 0, right: 0} : borders($element[0]),
            scroll: {
                top: (isRoot ? win : $element).scrollTop(),
                left: (isRoot ? win : $element).scrollLeft()
            },
            scrollbar: {
                right: isRoot ? 0 : $element.innerWidth() - $element[0].clientWidth,
                bottom: isRoot ? 0 : $element.innerHeight() - $element[0].clientHeight
            },
            rect: (function() {
                var r = $element[0].getBoundingClientRect();
                return {
                    top: isRoot ? 0 : r.top,
                    left: isRoot ? 0 : r.left,
                    bottom: isRoot ? $element[0].clientHeight : r.bottom,
                    right: isRoot ? $element[0].clientWidth : r.right
                };
            })()
        };
    };

    $.fn.extend({
        scrollIntoView: function(options) {
            /// <summary>Scrolls the first element in the set into view by scrolling its closest scrollable parent.</summary>
            /// <param name="options" type="Object">Additional options that can configure scrolling:
            ///        duration (default: "fast") - jQuery animation speed (can be a duration string or number of milliseconds)
            ///        direction (default: "both") - select possible scrollings ("vertical" or "y", "horizontal" or "x", "both")
            ///        complete (default: none) - a function to call when scrolling completes (called in context of the DOM element being scrolled)
            /// </param>
            /// <return type="jQuery">Returns the same jQuery set that this function was run on.</return>

            options = $.extend({}, settings, options);
            options.direction = converter[typeof (options.direction) === "string" && options.direction.toLowerCase()] || converter.both;

            var dirStr = "";
            if (options.direction.x === true) dirStr = "horizontal";
            if (options.direction.y === true) dirStr = dirStr ? "both" : "vertical";

            var el = this.eq(0);
            var scroller = el.closest(":scrollable(" + dirStr + ")");

            // check if there's anything to scroll in the first place
            if (scroller.length > 0) {
                scroller = scroller.eq(0);

                var dim = {
                    e: dimensions(el),
                    s: dimensions(scroller)
                };

                var rel = {
                    top: dim.e.rect.top - (dim.s.rect.top + dim.s.border.top),
                    bottom: dim.s.rect.bottom - dim.s.border.bottom - dim.s.scrollbar.bottom - dim.e.rect.bottom,
                    left: dim.e.rect.left - (dim.s.rect.left + dim.s.border.left),
                    right: dim.s.rect.right - dim.s.border.right - dim.s.scrollbar.right - dim.e.rect.right
                };

                var animOptions = {};

                // vertical scroll
                if (options.direction.y === true) {
                    if (rel.top < 0) {
                        animOptions.scrollTop = dim.s.scroll.top + rel.top;
                    }
                    else if (rel.top > 0 && rel.bottom < 0) {
                        animOptions.scrollTop = dim.s.scroll.top + Math.min(rel.top, -rel.bottom);
                    }
                }

                // horizontal scroll
                if (options.direction.x === true) {
                    if (rel.left < 0) {
                        animOptions.scrollLeft = dim.s.scroll.left + rel.left;
                    }
                    else if (rel.left > 0 && rel.right < 0) {
                        animOptions.scrollLeft = dim.s.scroll.left + Math.min(rel.left, -rel.right);
                    }
                }

                // scroll if needed
                if (!$.isEmptyObject(animOptions)) {
                    if (rootrx.test(scroller[0].nodeName)) {
                        scroller = $("html,body");
                    }
                    scroller
                        .animate(animOptions, options.duration)
                        .eq(0) // we want function to be called just once (ref. "html,body")
                        .queue(function(next) {
                            $.isFunction(options.complete) && options.complete.call(scroller[0]);
                            next();
                        });
                }
                else {
                    // when there's nothing to scroll, just call the "complete" function
                    $.isFunction(options.complete) && options.complete.call(scroller[0]);
                }
            }

            // return set back
            return this;
        }
    });

    var scrollValue = {
        auto: true,
        scroll: true,
        visible: false,
        hidden: false
    };

    $.extend($.expr[":"], {
        scrollable: function(element, index, meta, stack) {
            var direction = converter[typeof (meta[3]) === "string" && meta[3].toLowerCase()] || converter.both;
            var styles = (document.defaultView && document.defaultView.getComputedStyle ? document.defaultView.getComputedStyle(element, null) : element.currentStyle);
            var overflow = {
                x: scrollValue[styles.overflowX.toLowerCase()] || false,
                y: scrollValue[styles.overflowY.toLowerCase()] || false,
                isRoot: rootrx.test(element.nodeName)
            };

            // check if completely unscrollable (exclude HTML element because it's special)
            if (!overflow.x && !overflow.y && !overflow.isRoot) {
                return false;
            }

            var size = {
                height: {
                    scroll: element.scrollHeight,
                    client: element.clientHeight
                },
                width: {
                    scroll: element.scrollWidth,
                    client: element.clientWidth
                },
                // check overflow.x/y because iPad (and possibly other tablets) don't dislay scrollbars
                scrollableX: function() {
                    return (overflow.x || overflow.isRoot) && this.width.scroll > this.width.client;
                },
                scrollableY: function() {
                    return (overflow.y || overflow.isRoot) && this.height.scroll > this.height.client;
                }
            };
            return direction.y && size.scrollableY() || direction.x && size.scrollableX();
        }
    });
})(jQuery);